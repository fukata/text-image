<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Text Image</title>

  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
      <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css">
  <!--<![endif]-->
</head>
<body style="background-color: #ccc;">
  <form class="pure-form" onsubmit="createImage(); return false">
    <div class="pure-g">
      <div class="pure-u-1 pure-u-md-1-5">
        <p>テキスト(目安: 10文字程度)</p>
        <input type="text" id="image_text" value="Hello World">
      </div>

      <div class="pure-u-1 pure-u-md-1-5">
        <p>フォント</p>
        <select id="font" onchange="changeFont()">
        </select>
      </div>

      <div class="pure-u-1 pure-u-md-1-5">
        <p>プリセット</p>
        <select id="preset" onchange="changePreset()">
        </select>
      </div>
    </div>
    <div class="pure-g">
      <div class="pure-u-1 pure-u-md-1-5">
        <p>背景色</p>
        <input type="text" id="image_bgcolor" value="#ffffff">
      </div>
      <div class="pure-u-1 pure-u-md-1-5">
        <p>文字色</p>
        <input type="text" id="image_text_color" value="#333333">
      </div>
      <div class="pure-u-1 pure-u-md-1-5">
        <p>文字サイズ</p>
        <input type="number" id="image_text_size" value="128"> px
      </div>
      <div class="pure-u-1 pure-u-md-1-5">
        <p>画像サイズ(width)</p>
        <input type="number" id="image_width" value="1280"> px
      </div>
      <div class="pure-u-1 pure-u-md-1-5">
        <p>画像サイズ(height)</p>
        <input type="number" id="image_height" value="720"> px
      </div>
    </div>

    <hr>

    <div>
      <button type="submit" id="submit_button" class="pure-button pure-button-primary" onclick="createImage()">画像を作成</button>
      <a href="#" download="" id="download_link" class="pure-button pure-button-primary">ダウンロード</a>
      <button class="pure-button pure-button-primary" onclick="copyUrl(); return false">URLをコピー</button>
    </div>
  </form>

  <div>
    <p>プレビュー</p>
    <img src="" id="result_image">
  </div>

  <div style="display:none;">
    <p>ダミー</p>
    <canvas id="dummy_canvas" width="1280" height="720"></canvas>
  </div>

  <script>
    var fonts = [
      { label: 'Noto Sans JP, sans-serif', value: "'Noto Sans JP', sans-serif" },
      { label: 'Verdana', value: "Verdana" },
    ];
    var font = document.getElementById('font');
    for (var i=0; i<fonts.length; i++) {
      var r = fonts[i];
      var option = document.createElement('option');
      option.innerText = r.label;
      option.value = r.value;
      font.append(option);
    }

    var presets = [
      { label: 'YouTube (1280x720)', value: {image_width: 1280, image_height: 720} },
      { label: '16:9 (1920x1080)', value: {image_width: 1920, image_height: 1080} },
      { label: '4:3 (800x600)', value: {image_width: 800, image_height: 600} },
    ];
    var preset = document.getElementById('preset');
    for (var i=0; i<presets.length; i++) {
      var r = presets[i];
      var option = document.createElement('option');
      option.innerText = r.label;
      option.value = JSON.stringify(r.value);
      preset.append(option);
    }

    function changeFont() {
      console.log(event);
      createImage();
    };

    function changePreset() {
      console.log(event);
      var option = event.target.selectedOptions[0];
      var params = JSON.parse(option.value);
      if (params.image_width) {
        document.getElementById('image_width').value = params.image_width;
      }
      if (params.image_height) {
        document.getElementById('image_height').value = params.image_height;
      }

      createImage();
    };

    function fieldIds() {
       return [
        'image_text',
        'font',
        'preset',
        'image_bgcolor',
        'image_text_color',
        'image_text_size',
        'image_width',
        'image_height',
      ];
    };

    function serialize(obj) {
      var str = [];
      for (var p in obj)
        if (obj.hasOwnProperty(p)) {
          str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
        }
      return str.join("&");
    };

    function copyStringToClipboard(str) {
      // Create new element
      var el = document.createElement('textarea');
      // Set value (string to be copied)
      el.value = str;
      // Set non-editable to avoid focus and move outside of view
      el.setAttribute('readonly', '');
      el.style = {position: 'absolute', left: '-9999px'};
      document.body.appendChild(el);
      // Select text inside element
      el.select();
      // Copy text to clipboard
      document.execCommand('copy');
      // Remove temporary element
      document.body.removeChild(el);
    };

    function copyUrl() {
      copyStringToClipboard(window.location.href);
      alert('URLをコピーしました');
    }

    function restoreState() {
      var ids = fieldIds();
      var params = new URLSearchParams(window.location.hash.slice(2));
      for (var i=0; i<ids.length; i++) {
        var id = ids[i];
        var f = document.getElementById(id);
        var value = params.get(id);
        if (value) {
          if (id === 'font' || id === 'preset') {
            for (var j=0; f.options.length; j++) {
              var option = f.options[j];
              if (option.innerText === value) {
                option.selected = true;
                break;
              }
            }
          } else {
            f.value = value;
          }
        }
      }
    };

    function saveState() {
      var state = {};
      var ids = fieldIds();
      for (var i=0; i<ids.length; i++) {
        var id = ids[i];
        var f = document.getElementById(id);
        if (id === 'font' || id === 'preset') {
          state[id] = f.selectedOptions[0].innerText;
        } else {
          state[id] = f.value;
        }
      }
      window.history.replaceState('', '', '#!' + serialize(state));
    };

    function createImage() {
      saveState();
      var text = document.getElementById('image_text').value;

      // canvasを白色で初期化
      var imageWidth = document.getElementById('image_width').value;
      var imageHeight = document.getElementById('image_height').value;
      var canvas = document.getElementById('dummy_canvas');
      canvas.width = imageWidth;
      canvas.height = imageHeight;
      var ctx = canvas.getContext('2d');
      ctx.fillStyle = document.getElementById('image_bgcolor').value;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // canvasにテキストを書き込み
      var fontSize = document.getElementById('image_text_size').value;
      var fontFamily = document.getElementById('font').selectedOptions[0].value;
      ctx.font = fontSize + 'px ' + fontFamily;
      ctx.fillStyle = document.getElementById('image_text_color').value;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, imageWidth / 2, imageHeight / 2);

      // canvasからdataURLをimgにコピー
      var dataURL = canvas.toDataURL();
      document.getElementById('result_image').src = dataURL;

      // ダウンロードリンク更新
      var downloadLink = document.getElementById('download_link');
      download_link.href = dataURL;
      download_link.download = text + ".png";
    };

    restoreState();

    //TODO 指定のフォントがロードされたのを確認してから描画する
    createImage();
    setTimeout(function() {
      createImage();
    }, 1000);
  </script>
</body>
</html>
